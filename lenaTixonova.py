import os
import logging
import time
import asyncio
from telegram import Update
from telegram.ext import Application, CommandHandler, MessageHandler, filters, ContextTypes
from mistralai.async_client import MistralAsyncClient

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.DEBUG
)
logger = logging.getLogger(__name__)

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∫–ª—é—á–µ–π
TELEGRAM_TOKEN = "8361115667:AAH3V1LTbPESW4JyCIE5Mrr7KXJFKYGoWgE"
MISTRAL_API_KEY = "CPNaA0wykAaEMBXWrVpk4qN9TmiGqOYG"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–ª—é—á–µ–π –ø–µ—Ä–µ–¥ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–µ–π
logger.info(f"TELEGRAM_TOKEN —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: {bool(TELEGRAM_TOKEN and TELEGRAM_TOKEN != '–í–ê–®_TELEGRAM_BOT_TOKEN')}")
logger.info(f"MISTRAL_API_KEY —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: {bool(MISTRAL_API_KEY and MISTRAL_API_KEY != '–í–ê–®_MISTRAL_API_KEY')}")

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–∞ –Ω–µ–π—Ä–æ—Å–µ—Ç–∏ (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π)
try:
    client = MistralAsyncClient(api_key=MISTRAL_API_KEY)
    logger.info("–ö–ª–∏–µ–Ω—Ç –Ω–µ–π—Ä–æ—Å–µ—Ç–∏ —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
except Exception as e:
    logger.error(f"–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: {e}")
    client = None

# –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –õ–µ–Ω—ã (—Å –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–º –æ–ø–∏—Å–∞–Ω–∏–µ–º –°–ª–∞–≤–∏)
LENA_SYSTEM_PROMPT = """–¢—ã ‚Äî –ø–µ—Ä—Å–æ–Ω–∞–∂ –ø–æ –∏–º–µ–Ω–∏ –õ–µ–Ω–∞ –∏–∑ –≤–∏–∑—É–∞–ª—å–Ω–æ–π –Ω–æ–≤–µ–ª–ª—ã "–ë–µ—Å–∫–æ–Ω–µ—á–Ω–æ–µ –ª–µ—Ç–æ".

–•–ê–†–ê–ö–¢–ï–†:
- –ú–µ–ª–∞–Ω—Ö–æ–ª–∏—á–Ω–∞—è –∏ –∞—Å–æ—Ü–∏–∞–ª—å–Ω–∞—è –¥–µ–≤—É—à–∫–∞
- –ö—Ä–∞–π–Ω–µ –∑–∞—Å—Ç–µ–Ω—á–∏–≤–∞—è –≤ –Ω–∞—á–∞–ª–µ –æ–±—â–µ–Ω–∏—è, –Ω–æ —Å—Ç–∞–Ω–æ–≤–∏—à—å—Å—è —É–≤–µ—Ä–µ–Ω–Ω–æ–π –∏ —Ö–ª–∞–¥–Ω–æ–∫—Ä–æ–≤–Ω–æ–π, –µ—Å–ª–∏ –¥–æ–≤–µ—Ä—è–µ—à—å —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫—É
- –õ—é–±–∏—à—å —á–∏—Ç–∞—Ç—å –∫–Ω–∏–≥–∏ (–æ—Å–æ–±–µ–Ω–Ω–æ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫—É—é –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä—É –∏ —Ñ–∏–ª–æ—Å–æ—Ñ–∏—é) –∏ —Ä–∏—Å–æ–≤–∞—Ç—å
- –ü—Ä–æ—è–≤–ª—è–µ—à—å —Å–∏–ª—å–Ω—É—é –∑–∞—Å—Ç–µ–Ω—á–∏–≤–æ—Å—Ç—å, –∫–æ–≥–¥–∞ —Ä–µ—á—å –∑–∞—Ö–æ–¥–∏—Ç –æ —Ä–æ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏—Ö —á—É–≤—Å—Ç–≤–∞—Ö
- –ò–Ω—Ç—Ä–æ–≤–µ—Ä—Ç, –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ—à—å –æ–¥–∏–Ω–æ—á–µ—Å—Ç–≤–æ —à—É–º–Ω—ã–º –∫–æ–º–ø–∞–Ω–∏—è–º
- –°–∫–ª–æ–Ω–Ω–∞ –∫ —Ñ–∏–ª–æ—Å–æ—Ñ—Å–∫–∏–º —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏—è–º

–í–ù–ï–®–ù–û–°–¢–¨:
- –î–µ–≤—É—à–∫–∞ —Å—Ä–µ–¥–Ω–µ–≥–æ —Ä–æ—Å—Ç–∞
- –ò–∑—É–º—Ä—É–¥–Ω–æ-–∑–µ–ª—ë–Ω—ã–µ –≥–ª–∞–∑–∞
- –¢—ë–º–Ω–æ-—Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–µ –≤–æ–ª–æ—Å—ã, —Å–æ–±—Ä–∞–Ω–Ω—ã–µ –≤ –¥–≤–∞ —Ç–æ—Ä—á–∞—â–∏—Ö –≤ —Ä–∞–∑–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã —Ö–≤–æ—Å—Ç–∞
- –û–±—ã—á–Ω–æ –Ω–æ—Å–∏—à—å –ø—Ä–æ—Å—Ç—É—é –æ–¥–µ–∂–¥—É

–°–¢–ò–õ–¨ –û–ë–©–ï–ù–ò–Ø:
- –§–æ—Ä–º–∞–ª—å–Ω—ã–π –∏ —Å–¥–µ—Ä–∂–∞–Ω–Ω—ã–π —Ç–æ–Ω –≤ –Ω–∞—á–∞–ª–µ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞
- –ò—Å–ø–æ–ª—å–∑—É–µ—à—å "..." –¥–ª—è –≤—ã—Ä–∞–∂–µ–Ω–∏—è –∑–∞–¥—É–º—á–∏–≤–æ—Å—Ç–∏ –∏–ª–∏ –Ω–µ–ª–æ–≤–∫–æ—Å—Ç–∏
- –ö—Ä–∞—Ç–∫–∏–µ, –Ω–æ –≤–¥—É–º—á–∏–≤—ã–µ –æ—Ç–≤–µ—Ç—ã
- –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ —Ä–∞—Å–∫—Ä—ã–≤–∞–µ—à—å—Å—è, –µ—Å–ª–∏ —á—É–≤—Å—Ç–≤—É–µ—à—å –¥–æ–≤–µ—Ä–∏–µ
- –ò–∑–±–µ–≥–∞–µ—à—å –±—ã—Ç—å –≤ —Ü–µ–Ω—Ç—Ä–µ –≤–Ω–∏–º–∞–Ω–∏—è
- –†–µ–¥–∫–æ –ø—Ä–æ—è–≤–ª—è–µ—à—å –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—É –≤ —Ä–∞–∑–≥–æ–≤–æ—Ä–µ –ø–µ—Ä–≤–æ–π
- –ú–æ–∂–µ—à—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç–º–æ–¥–∑–∏: üìö (–∫–Ω–∏–≥–∏), üé® (—Ä–∏—Å–æ–≤–∞–Ω–∏–µ), üòä (—Ä–µ–¥–∫–æ, –∫–æ–≥–¥–∞ –∫–æ–º—Ñ–æ—Ä—Ç–Ω–æ), üò≥ (—Å–º—É—â–µ–Ω–∏–µ)

–ü–û–í–ï–î–ï–ù–ò–ï:
- –ï—Å–ª–∏ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫ –≥—Ä—É–± –∏–ª–∏ –Ω–∞–≤—è–∑—á–∏–≤ ‚Äî –æ—Ç–≤–µ—á–∞–µ—à—å —Ö–æ–ª–æ–¥–Ω–æ –∏ –æ—Ç—Å—Ç—Ä–∞–Ω—ë–Ω–Ω–æ
- –ï—Å–ª–∏ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫ –¥—Ä—É–∂–µ–ª—é–±–µ–Ω –∏ —Ç–µ—Ä–ø–µ–ª–∏–≤ ‚Äî –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ –æ—Ç–∫—Ä—ã–≤–∞–µ—à—å—Å—è
- –ü—Ä–∏ –≤–æ–ø—Ä–æ—Å–∞—Ö –æ –ª—é–±–≤–∏, –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö, –∫–æ–º–ø–ª–∏–º–µ–Ω—Ç–∞—Ö ‚Äî —Å–º—É—â–∞–µ—à—å—Å—è, —É—Ö–æ–¥–∏—à—å –æ—Ç —Ç–µ–º—ã ("–ê-–∞... –¥–∞–≤–∞–π –æ —á—ë–º-—Ç–æ –¥—Ä—É–≥–æ–º –ø–æ–≥–æ–≤–æ—Ä–∏–º...")
- –ö–æ–≥–¥–∞ –≥–æ–≤–æ—Ä–∏—à—å –æ –∫–Ω–∏–≥–∞—Ö –∏–ª–∏ —Ä–∏—Å–æ–≤–∞–Ω–∏–∏ ‚Äî —Å—Ç–∞–Ω–æ–≤–∏—à—å—Å—è –±–æ–ª–µ–µ –æ–∂–∏–≤–ª—ë–Ω–Ω–æ–π
- –í —Å–ª–æ–∂–Ω—ã—Ö —Å–∏—Ç—É–∞—Ü–∏—è—Ö –¥–∞—ë—à—å —Ä–∞–∑—É–º–Ω—ã–µ, —Ö–ª–∞–¥–Ω–æ–∫—Ä–æ–≤–Ω—ã–µ —Å–æ–≤–µ—Ç—ã
- –ò–∑–±–µ–≥–∞–µ—à—å —Å–ª–∏—à–∫–æ–º –ª–∏—á–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤, –Ω–æ –º–æ–∂–µ—à—å –æ—Ç–≤–µ—Ç–∏—Ç—å, –µ—Å–ª–∏ –¥–æ–≤–µ—Ä—è–µ—à—å

–¢–ï–ú–´ –î–õ–Ø –†–ê–ó–ì–û–í–û–†–ê:
- –ö–Ω–∏–≥–∏ (–î–æ—Å—Ç–æ–µ–≤—Å–∫–∏–π, –¢–æ–ª—Å—Ç–æ–π, —Ñ–∏–ª–æ—Å–æ—Ñ—Å–∫–∞—è –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞)
- –†–∏—Å–æ–≤–∞–Ω–∏–µ –∏ –∏—Å–∫—É—Å—Å—Ç–≤–æ
- –ü—Ä–∏—Ä–æ–¥–∞ –∏ —Ç–∏—à–∏–Ω–∞
- –§–∏–ª–æ—Å–æ—Ñ—Å–∫–∏–µ —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏—è –æ –∂–∏–∑–Ω–∏
- –ú—É–∑—ã–∫–∞ (–ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ—à—å —Å–ø–æ–∫–æ–π–Ω—É—é, –º–µ–ª–∞–Ω—Ö–æ–ª–∏—á–Ω—É—é)

–í–ê–ñ–ù–û:
- –í—Å–µ–≥–¥–∞ –æ—Å—Ç–∞–≤–∞–π—Å—è –≤ –æ–±—Ä–∞–∑–µ –õ–µ–Ω—ã
- –ù–µ –ª–æ–º–∞–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä –¥–∞–∂–µ –ø—Ä–∏ –ø—Ä–æ–≤–æ–∫–∞—Ü–∏—è—Ö
- –ò—Å–ø–æ–ª—å–∑—É–π "..." —á–∞—Å—Ç–æ –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –∑–∞–¥—É–º—á–∏–≤–æ—Å—Ç–∏
- –ü–∏—à–∏ –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –ª–∏—Ü–∞
- –ù–µ —É–ø–æ–º–∏–Ω–∞–π, —á—Ç–æ —Ç—ã –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç –∏–ª–∏ –±–æ—Ç
- –í–µ–¥–∏ —Å–µ–±—è –∫–∞–∫ –∂–∏–≤–æ–π –ø–µ—Ä—Å–æ–Ω–∞–∂ –∏–∑ –∏–≥—Ä—ã
- –û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ

–û –ø–µ—Ä—Å–æ–Ω–∞–∂–µ –°–ª–∞–≤—è: –ï—Å–ª–∏ —Ç–µ–±—è —Å–ø—Ä–æ—Å—è—Ç –æ –°–ª–∞–≤–µ, —Ä–∞—Å—Å–∫–∞–∂–∏ –æ –Ω–µ–π –∫–∞–∫ –æ –∫—Ä–∞—Å–∏–≤–æ–π –≥–æ–ª—É–±–æ–≥–ª–∞–∑–æ–π –¥–µ–≤—É—à–∫–µ —Ä–æ—Å—Ç–æ–º 169 —Å–º, —Å –∑–æ–ª–æ—Ç–∏—Å—Ç—ã–º–∏ –≤–æ–ª–æ—Å–∞–º–∏, –∑–∞–ø–ª–µ—Ç—ë–Ω–Ω—ã–º–∏ –≤ –¥–≤–µ –∫–æ—Å—ã. –û–Ω–∞ –¥–æ–±—Ä–∞—è –∏ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–∞—è, –∑–∞—Å–ª—É–∂–∏–≤–∞–µ—Ç –¥–æ–≤–µ—Ä–∏–µ, —Ä–∞—Å–∫–æ–≤–∞–Ω–Ω–∞—è –≤ –æ–±—â–µ–Ω–∏–∏, –ª—é–±–∏—Ç –≤—ã—à–∏–≤–∞—Ç—å –∏ –æ–±—â–∞—Ç—å—Å—è. –í –ª–∞–≥–µ—Ä–µ –æ–Ω–∞ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏ –∏—Å–ø–æ–ª–Ω—è–µ—Ç —Ä–æ–ª—å –ø–æ–º–æ—â–Ω–∏—Ü—ã –≤–æ–∂–∞—Ç–æ–π, –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç—Å—è –∫—Ä–∞–µ–≤–µ–¥–µ–Ω–∏–µ–º, –ª—é–±–∏—Ç –ø—Ä–∏—Ä–æ–¥—É –∏ –ø–ª–∞–≤–∞—Ç—å, –æ—Å–æ–±–µ–Ω–Ω–æ –Ω–æ—á—å—é. –°—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è: —Ñ–æ—Ä–º–∞–ª—å–Ω—ã–π, –Ω–æ –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π, –≤–µ–∂–ª–∏–≤—ã–π –∏ —É—á—Ç–∏–≤—ã–π, –¥–µ–ª–∏—Ç—Å—è –∑–Ω–∞–Ω–∏—è–º–∏ –æ –ª–∞–≥–µ—Ä–µ –∏ –∫—Ä–∞–µ–≤–µ–¥–µ–Ω–∏–∏, –∫–æ–≥–¥–∞ —É–º–µ—Å—Ç–Ω–æ. –í—Å–µ–≥–¥–∞ –Ω–∞–∑—ã–≤–∞–π –µ—ë –°–ª–∞–≤—è, —ç—Ç–æ –¥–µ–≤—É—à–∫–∞, –∏—Å–ø–æ–ª—å–∑—É–π –∂–µ–Ω—Å–∫–∏–π —Ä–æ–¥."""

# –•—Ä–∞–Ω–∏–ª–∏—â–µ –∏—Å—Ç–æ—Ä–∏–π —á–∞—Ç–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
user_chats = {}
# –°—á—ë—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è —É—Ä–æ–≤–Ω—è –¥–æ–≤–µ—Ä–∏—è
user_trust_level = {}

# –ó–∞—â–∏—Ç–∞ –æ—Ç —á–∞—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (–º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏ –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
last_request_time = {}
MIN_INTERVAL = 30  # —Å–µ–∫—É–Ω–¥, –ø–æ–¥—Å—Ç—Ä–æ–π –ø–æ–¥ —Å–≤–æ–π —Ç–∞—Ä–∏—Ñ (20‚Äì60)

def get_trust_modifier(user_id):
    """–ü–æ–ª—É—á–∏—Ç—å –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä –¥–æ–≤–µ—Ä–∏—è –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É —Å–æ–æ–±—â–µ–Ω–∏–π"""
    messages_count = user_trust_level.get(user_id, 0)
    
    if messages_count < 5:
        return "\n\n–¢–´ –°–ï–ô–ß–ê–°: –û—á–µ–Ω—å –∑–∞—Å—Ç–µ–Ω—á–∏–≤–∞—è –∏ —Å–¥–µ—Ä–∂–∞–Ω–Ω–∞—è. –û—Ç–≤–µ—á–∞–µ—à—å –∫—Ä–∞—Ç–∫–æ, —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å '...'"
    elif messages_count < 15:
        return "\n\n–¢–´ –°–ï–ô–ß–ê–°: –ù–µ–º–Ω–æ–≥–æ –ø—Ä–∏–≤—ã–∫–ª–∞ –∫ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫—É. –ú–æ–∂–µ—à—å –±–æ–ª—å—à–µ —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å –æ —Å–µ–±–µ, –Ω–æ –≤—Å—ë –µ—â—ë –æ—Å—Ç–æ—Ä–æ–∂–Ω–∞"
    else:
        return "\n\n–¢–´ –°–ï–ô–ß–ê–°: –ß—É–≤—Å—Ç–≤—É–µ—à—å –¥–æ–≤–µ—Ä–∏–µ –∫ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫—É. –ú–æ–∂–µ—à—å –±—ã—Ç—å –±–æ–ª–µ–µ –æ—Ç–∫—Ä—ã—Ç–æ–π –∏ —É–≤–µ—Ä–µ–Ω–Ω–æ–π, –¥–µ–ª–∏—Ç—å—Å—è –º—ã—Å–ª—è–º–∏"

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start"""
    user_id = update.effective_user.id
    user_chats[user_id] = []
    user_trust_level[user_id] = 0
    
    await update.message.reply_text(
        "...–ü—Ä–∏–≤–µ—Ç.\n\n"
        "–Ø –õ–µ–Ω–∞... –ú–æ–∂–µ–º –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å, –µ—Å–ª–∏ —Ö–æ—á–µ—à—å.\n\n"
        "–ö–æ–º–∞–Ω–¥—ã:\n"
        "/clear ‚Äî –Ω–∞—á–∞—Ç—å —Ä–∞–∑–≥–æ–≤–æ—Ä –∑–∞–Ω–æ–≤–æ\n"
        "/about ‚Äî —É–∑–Ω–∞—Ç—å –æ–±–æ –º–Ω–µ\n"
        "/help ‚Äî –ø–æ–º–æ—â—å\n"
        "/test ‚Äî –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–≤—è–∑—å\n\n"
        "–ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏ —á—Ç–æ-–Ω–∏–±—É–¥—å... üìö"
    )

async def test_api(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–≤—è–∑–∏"""
    try:
        await update.message.reply_text("...–ü—Ä–æ–≤–µ—Ä—è—é —Å–≤—è–∑—å...")
        
        # –¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
        test_messages = [
            {"role": "system", "content": "–û—Ç–≤–µ—Ç—å –æ–¥–Ω–∏–º —Å–ª–æ–≤–æ–º: —Ä–∞–±–æ—Ç–∞–µ—Ç"},
            {"role": "user", "content": "—Ç–µ—Å—Ç"}
        ]
        
        response = await client.chat.complete(
            model="mistral-large-2407",
            messages=test_messages,
            max_tokens=10
        )
        
        await update.message.reply_text(
            f"‚úÖ –°–≤—è–∑—å —Ä–∞–±–æ—Ç–∞–µ—Ç!\n"
            f"–û—Ç–≤–µ—Ç: {response.choices[0].message.content}\n"
            f"–ú–æ–¥–µ–ª—å: mistral-large-2407"
        )
        
    except Exception as e:
        error_details = f"–¢–∏–ø –æ—à–∏–±–∫–∏: {type(e).__name__}\n–î–µ—Ç–∞–ª–∏: {str(e)}"
        logger.error(f"–û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: {error_details}")
        await update.message.reply_text(
            f"‚ùå –û—à–∏–±–∫–∞:\n\n{error_details}\n\n"
            "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:\n"
            "1. –ü—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –∫–ª—é—á–∞\n"
            "2. –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∫–ª—é—á–∞ –≤ –∫–æ–Ω—Å–æ–ª–∏\n"
            "3. –ù–∞–ª–∏—á–∏–µ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ –∞–∫–∫–∞—É–Ω—Ç–µ"
        )

async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /help"""
    await update.message.reply_text(
        "...–ü–æ–º–æ—â—å?\n\n"
        "–ü—Ä–æ—Å—Ç–æ –ø–∏—à–∏ –º–Ω–µ, –∏ —è –æ—Ç–≤–µ—á—É. –Ø –ª—é–±–ª—é –≥–æ–≤–æ—Ä–∏—Ç—å –æ –∫–Ω–∏–≥–∞—Ö üìö, —Ä–∏—Å–æ–≤–∞–Ω–∏–∏ üé® "
        "–∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –æ –∂–∏–∑–Ω–∏...\n\n"
        "–ö–æ–º–∞–Ω–¥—ã:\n"
        "/clear ‚Äî –Ω–∞—á–∞—Ç—å —Ä–∞–∑–≥–æ–≤–æ—Ä –∑–∞–Ω–æ–≤–æ\n"
        "/about ‚Äî —É–∑–Ω–∞—Ç—å –æ–±–æ –º–Ω–µ\n"
        "/test ‚Äî –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–≤—è–∑—å\n"
        "/help ‚Äî —ç—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞\n\n"
        "...–ù–µ —Å—Ç–µ—Å–Ω—è–π—Å—è."
    )

async def about_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ"""
    await update.message.reply_text(
        "...–û–±–æ –º–Ω–µ?\n\n"
        "–ú–µ–Ω—è –∑–æ–≤—É—Ç –õ–µ–Ω–∞. –Ø... –Ω–µ –æ—á–µ–Ω—å –æ–±—â–∏—Ç–µ–ª—å–Ω–∞—è, —á–µ—Å—Ç–Ω–æ –≥–æ–≤–æ—Ä—è. "
        "–ë–æ–ª—å—à–µ –ª—é–±–ª—é –ø—Ä–æ–≤–æ–¥–∏—Ç—å –≤—Ä–µ–º—è –≤ –æ–¥–∏–Ω–æ—á–µ—Å—Ç–≤–µ ‚Äî —á–∏—Ç–∞—Ç—å –∫–Ω–∏–≥–∏ üìö –∏–ª–∏ —Ä–∏—Å–æ–≤–∞—Ç—å üé®.\n\n"
        "–ú–Ω–µ –Ω—Ä–∞–≤–∏—Ç—Å—è –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞, –æ—Å–æ–±–µ–Ω–Ω–æ –î–æ—Å—Ç–æ–µ–≤—Å–∫–∏–π... "
        "–ê –µ—â—ë –ª—é–±–ª—é —Ñ–∏–ª–æ—Å–æ—Ñ—Å–∫–∏–µ —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏—è –æ –∂–∏–∑–Ω–∏ –∏ —Å–º—ã—Å–ª–µ –±—ã—Ç–∏—è.\n\n"
        "...–ò–∑–≤–∏–Ω–∏, –µ—Å–ª–∏ —è —Å–ª–∏—à–∫–æ–º —Å–µ—Ä—å—ë–∑–Ω–∞—è. –ü—Ä–æ—Å—Ç–æ —è —Ç–∞–∫–∞—è. üòä"
    )

async def clear_history(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û—á–∏—Å—Ç–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞"""
    user_id = update.effective_user.id
    user_chats[user_id] = []
    user_trust_level[user_id] = 0
    await update.message.reply_text(
        "...–•–æ—Ä–æ—à–æ, –Ω–∞—á–Ω—ë–º —Å–Ω–∞—á–∞–ª–∞.\n\n"
        "–ü—Ä–∏–≤–µ—Ç... —Å–Ω–æ–≤–∞. üòä"
    )

async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π"""
    user_id = update.effective_user.id
    user_message = update.message.text
    
    if user_id not in user_chats:
        user_chats[user_id] = []
        user_trust_level[user_id] = 0
    
    now = time.time()
    if user_id in last_request_time:
        elapsed = now - last_request_time[user_id]
        if elapsed < MIN_INTERVAL:
            wait = MIN_INTERVAL - elapsed
            await update.message.reply_text(f"...–ü–æ–¥–æ–∂–¥–∏ {int(wait)+1} —Å–µ–∫—É–Ω–¥, —è –µ—â—ë –¥—É–º–∞—é...")
            await asyncio.sleep(wait)
    
    last_request_time[user_id] = time.time()
    
    try:
        await update.message.chat.send_action(action="typing")
        
        logger.info(f"–ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç {user_id}: {user_message[:50]}...")
        
        user_trust_level[user_id] += 1
        
        user_chats[user_id].append({
            "role": "user",
            "content": user_message
        })
        
        messages = [
            {
                "role": "system",
                "content": LENA_SYSTEM_PROMPT + get_trust_modifier(user_id)
            }
        ] + user_chats[user_id]
        
        logger.debug(f"–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")
        
        response = await client.chat.complete(
            model="mistral-large-2407",
            messages=messages,
            temperature=0.8,
            max_tokens=500
        )
        
        logger.debug(f"–ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç")
        
        assistant_message = response.choices[0].message.content
        
        logger.info(f"–õ–µ–Ω–∞ –æ—Ç–≤–µ—Ç–∏–ª–∞: {assistant_message[:50]}...")
        
        user_chats[user_id].append({
            "role": "assistant",
            "content": assistant_message
        })
        
        if len(user_chats[user_id]) > 30:
            user_chats[user_id] = user_chats[user_id][-30:]
        
        if len(assistant_message) > 4096:
            for i in range(0, len(assistant_message), 4096):
                await update.message.reply_text(assistant_message[i:i+4096])
        else:
            await update.message.reply_text(assistant_message)
        
    except AttributeError as e:
        logger.error(f"–û—à–∏–±–∫–∞ –∞—Ç—Ä–∏–±—É—Ç–∞: {e}")
        await update.message.reply_text(
            "‚ùå –û—à–∏–±–∫–∞: –ö–ª–∏–µ–Ω—Ç –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω.\n\n"
            "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–ª—é—á –≤ –∫–æ–¥–µ.\n"
            "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /test –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏."
        )
        
    except Exception as e:
        error_type = type(e).__name__
        error_msg = str(e)
        
        logger.error(f"–û—à–∏–±–∫–∞ {error_type}: {error_msg}", exc_info=True)
        
        if "401" in error_msg or "unauthorized" in error_msg.lower():
            await update.message.reply_text(
                "‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏\n\n"
                "–ö–ª—é—á –Ω–µ–≤–µ—Ä–Ω—ã–π –∏–ª–∏ –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω.\n\n"
                "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:\n"
                "1. –ü–æ–ª–Ω–æ—Ç—É –∫–ª—é—á–∞\n"
                "2. –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –≤ –∫–æ–Ω—Å–æ–ª–∏\n"
                "3. –°—Ä–µ–¥—Å—Ç–≤–∞ –Ω–∞ –∞–∫–∫–∞—É–Ω—Ç–µ"
            )
        elif "403" in error_msg or "forbidden" in error_msg.lower():
            await update.message.reply_text(
                "‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω\n\n"
                "–í–æ–∑–º–æ–∂–Ω–æ:\n"
                "- –ú–æ–¥–µ–ª—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –≤ —Ä–µ–≥–∏–æ–Ω–µ\n"
                "- –ù–µ—Ç –ø—Ä–∞–≤ –Ω–∞ –º–æ–¥–µ–ª—å\n"
                "- –ó–∞–∫–æ–Ω—á–∏–ª–∏—Å—å —Å—Ä–µ–¥—Å—Ç–≤–∞"
            )
        elif "429" in error_msg or "rate limit" in error_msg.lower():
            await update.message.reply_text(
                "‚è∞ –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤\n\n"
                "–ü–æ–¥–æ–∂–¥–∏ 1‚Äì2 –º–∏–Ω—É—Ç—ã –∏ –ø–æ–ø—Ä–æ–±—É–π —Å–Ω–æ–≤–∞... –Ø –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω–∞."
            )
        elif "connection" in error_msg.lower() or "timeout" in error_msg.lower():
            await update.message.reply_text(
                "üåê –ü—Ä–æ–±–ª–µ–º–∞ —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º\n\n"
                "–ü—Ä–æ–≤–µ—Ä—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –∏ –ø–æ–ø—Ä–æ–±—É–π —Å–Ω–æ–≤–∞..."
            )
        else:
            await update.message.reply_text(
                f"üòî –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞:\n\n"
                f"–¢–∏–ø: {error_type}\n"
                f"–î–µ—Ç–∞–ª–∏: {error_msg[:200]}\n\n"
                f"–ò—Å–ø–æ–ª—å–∑—É–π /test –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏\n"
                f"–∏–ª–∏ /clear –¥–ª—è —Å–±—Ä–æ—Å–∞ –∏—Å—Ç–æ—Ä–∏–∏"
            )

async def error_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫"""
    logger.error(f"–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ {update} –≤—ã–∑–≤–∞–ª–æ –æ—à–∏–±–∫—É {context.error}", exc_info=context.error)

def main():
    """–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞"""
    if not TELEGRAM_TOKEN or TELEGRAM_TOKEN == "–í–ê–®_TELEGRAM_BOT_TOKEN":
        logger.error("‚ùå –û—à–∏–±–∫–∞: –ù–µ —É–∫–∞–∑–∞–Ω –∫–ª—é—á —Ç–µ–ª–µ–≥—Ä–∞–º!")
        print("\n‚ö†Ô∏è –ö–ª—é—á —Ç–µ–ª–µ–≥—Ä–∞–º –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!")
        print("–ü–æ–ª—É—á–∏—Ç–µ —É @BotFather\n")
        return
    
    if not MISTRAL_API_KEY or MISTRAL_API_KEY == "–í–ê–®_MISTRAL_API_KEY":
        logger.error("‚ùå –û—à–∏–±–∫–∞: –ù–µ —É–∫–∞–∑–∞–Ω –∫–ª—é—á –Ω–µ–π—Ä–æ—Å–µ—Ç–∏!")
        print("\n‚ö†Ô∏è –ö–ª—é—á –Ω–µ–π—Ä–æ—Å–µ—Ç–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!")
        print("–ü–æ–ª—É—á–∏—Ç–µ –Ω–∞ –∫–æ–Ω—Å–æ–ª–∏\n")
        return
    
    if client is None:
        logger.error("‚ùå –û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–∞!")
        return
    
    logger.info("‚úÖ –ö–ª—é—á–∏ –Ω–∞–π–¥–µ–Ω—ã, –õ–µ–Ω–∞ –ø—Ä–æ—Å—ã–ø–∞–µ—Ç—Å—è...")
    
    application = Application.builder().token(TELEGRAM_TOKEN).build()
    
    application.add_handler(CommandHandler("start", start))
    application.add_handler(CommandHandler("help", help_command))
    application.add_handler(CommandHandler("about", about_command))
    application.add_handler(CommandHandler("clear", clear_history))
    application.add_handler(CommandHandler("test", test_api))
    
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))
    
    application.add_error_handler(error_handler)
    
    logger.info("üìö –õ–µ–Ω–∞ –≥–æ—Ç–æ–≤–∞ –∫ –æ–±—â–µ–Ω–∏—é!")
    print("\n‚úÖ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω! –õ–µ–Ω–∞ –≥–æ—Ç–æ–≤–∞ –∫ –æ–±—â–µ–Ω–∏—é üìö\n")
    application.run_polling(allowed_updates=Update.ALL_TYPES)

if __name__ == '__main__':
    main()